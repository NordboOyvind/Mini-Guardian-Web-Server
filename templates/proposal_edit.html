{% extends 'base.html' %}
{% block title %}Edit proposal{% endblock %}
{% block content %}
<h3>Edit proposal</h3> 
<div class="spacer"></div>
<form method="post" class="grid cols-2">
  <div>
    <label>Title</label>
    <input type="text" name="title" value="{{ proposal.title }}" required>
  </div>
  <div>
    <label>Departure location</label>
    <input id="departure" type="text" name="departure_location" value="{{ proposal.departure_location or '' }}" autocomplete="off">
    <div id="departure-list" class="autocomplete-list" aria-hidden="true"></div>
  </div>
  <div>
    <label>Destination</label>
    <input id="destination" type="text" name="destination" value="{{ proposal.destination or '' }}" autocomplete="off">
    <div id="destination-list" class="autocomplete-list" aria-hidden="true"></div>
  </div>
  <div>
    <label>Activities (comma-separated)</label>
    <textarea name="activities" rows="3" placeholder="e.g. hiking, museums, food tours">{{ proposal.activities or '' }}</textarea>
  </div>
  <div>
    <label>Budget</label>
    <input type="number" name="budget" step="0.01" min="0" value="{{ proposal.budget if proposal.budget is not none else '' }}">
  </div>
  <div>
    <label>Max participants</label>
    <input type="number" name="max_participants" min="1" value="{{ proposal.max_participants or 4 }}" required>
  </div>
  <div>
    <label>Start date</label>
    <input type="date" name="start_date" value="{{ proposal.start_date.strftime('%Y-%m-%d') if proposal.start_date else '' }}">
  </div>
  <div>
    <label>End date</label>
    <input type="date" name="end_date" value="{{ proposal.end_date.strftime('%Y-%m-%d') if proposal.end_date else '' }}">
  </div>
  <div class="col-span-2 actions">
    <button class="btn" type="submit">Save changes</button>
    <a class="btn secondary" href="{{ url_for('proposals.proposal_detail', proposal_id=proposal.id) }}">Cancel</a>
  </div>
</form>
<div style="margin-top: 1.5em;">
  <small class="muted">Address autocomplete powered by <a href="https://www.openstreetmap.org" target="_blank" rel="noopener noreferrer">OpenStreetMap</a> (suggestions only).</small>
</div>

<script>
// Lightweight autocomplete using Nominatim (OpenStreetMap)
function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); }; }

function attachAutocomplete(inputId, listId){
  const input = document.getElementById(inputId);
  const list = document.getElementById(listId);

  if(!input || !list) return;

  const render = (items)=>{
    list.innerHTML = '';
    if(!items || items.length===0){ list.style.display='none'; return; }
    items.forEach(it=>{
      const div = document.createElement('div');
      div.className = 'autocomplete-item';
      div.textContent = it.display_name;
      div.addEventListener('click', ()=>{
        input.value = it.display_name;
        list.style.display = 'none';
      });
      list.appendChild(div);
    });
    list.style.display = 'block';
  };

  const search = debounce(async (q)=>{
    if(!q || q.length<3){ render([]); return; }
    try{
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5`);
      const data = await res.json();
      render(data);
    }catch(e){ console.error(e); render([]); }
  }, 300);

  input.addEventListener('input', (e)=>search(e.target.value));
  input.addEventListener('blur', ()=>setTimeout(()=>list.style.display='none', 200));
}

attachAutocomplete('departure', 'departure-list');
attachAutocomplete('destination', 'destination-list');
</script>

{% endblock %}
